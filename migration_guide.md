# Инструкция по обновлению сервера (Миграция)

Поскольку мы значительно изменили структуру проекта (обновили Docker, настройки безопасности, скрипты установки), старый метод "просто заменить папку src" **не сработает**.

Нужно выполнить полное обновление файлов, **сохранив при этом базу данных**.

## ⚠️ Самое важное
Ваши данные (клиенты, ключи, настройки) хранятся в файле **`users.db`**.
Этот файл — самое ценное. **НИКОГДА не удаляйте его.**

---

## Пошаговый план действий

### 1. Подготовка (на сервере)
Зайдите на сервер через SSH и перейдите в папку с ботом:
```bash
cd vless-shopbot
```
*(Или как у вас называется папка, например `cd "мой текущий"`, если вы не переименовывали)*

### 2. Остановка старой версии
Остановите текущие контейнеры:
```bash
docker-compose down
```

### 3. Резервное копирование (ОБЯЗАТЕЛЬНО)
Скопируйте базу данных в безопасное место (например, в домашнюю папку), чтобы случайно не потерять:
```bash
cp users.db ~/users.db.backup
```

### 4. Очистка старых файлов
Теперь удалите все старые файлы проекта, **КРОМЕ** базы данных `users.db`.
Можно сделать это вручную или командой (будьте осторожны!):

**Вариант А (Безопасный - через SFTP/FileZilla):**
1.  Подключитесь к серверу через FileZilla.
2.  Скачайте `users.db` на свой компьютер (для надежности).
3.  Удалите ВСЕ файлы в папке проекта на сервере, **кроме `users.db`**.

**Вариант Б (Командная строка):**
```bash
# Удаляем всё кроме базы данных (команда удалит все файлы и папки кроме users.db)
find . -mindepth 1 -not -name 'users.db' -delete
```

### 5. Загрузка новой версии
Теперь нужно загрузить файлы из новой папки `vless-shopbot` (которую мы сделали) на сервер в эту же очищенную папку.

1.  Скопируйте **ВСЕ** файлы из новой папки (включая `Dockerfile`, `docker-compose.yml`, `install.sh`, папку `src`, `requirements.txt` и т.д.).
2.  Вставьте их на сервер рядом с файлом `users.db`.

### 6. Настройка окружения
В новой версии мы используем файл `.env`.
1.  Создайте файл `.env` и заполните его актуальными данными:
    ```bash
    nano .env
    ```
2.  Редактировать его **НЕ ОБЯЗАТЕЛЬНО**, если у вас старая база данных. Бот возьмет токен и настройки из `users.db`.
    *Но для порядка можете открыть его и вписать `TELEGRAM_BOT_TOKEN`, чтобы docker не ругался.*

### 7. Запуск новой версии
Так как мы поменяли версию Python и настройки контейнера, нужно пересобрать его с флагом `--build`:

```bash
docker-compose up -d --build
```

### 8. Проверка
1.  Введите `docker-compose logs -f`, чтобы убедиться, что ошибок нет.
2.  Бот должен запуститься, подхватить старую базу `users.db` и продолжить работу с новыми функциями.
3.  В админ-панели теперь появится раздел "Обновления".

---

## Краткая шпаргалка (если вы опытный)

1.  `docker-compose down`
2.  Сохранить `users.db`.
3.  `git pull` (или залить новые файлы поверх старых, удалив лишнее, но **оставив users.db**).
4.  Создать `.env` (можно пустой/из примера).
5.  `docker-compose up -d --build`
