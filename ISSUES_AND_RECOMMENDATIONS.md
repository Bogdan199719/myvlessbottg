# üîç –ê–Ω–∞–ª–∏–∑ –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ú–µ—Å—Ç –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

> –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ –∫–æ–¥–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Ö —Ä–µ—à–µ–Ω–∏—é.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã](#–∫—Ä–∏—Ç–∏—á–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
2. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é)
3. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é)
4. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é)
5. [–ü—Ä–æ–±–ª–µ–º—ã —Å –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é](#–ø—Ä–æ–±–ª–µ–º—ã-—Å-–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é)
6. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –£–ª—É—á—à–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)

---

## üö® –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

### 1. **Race Condition –≤ –í—ã–¥–∞—á–µ –ö–ª—é—á–µ–π**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å" –¥–≤–∞ —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–æ, –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –¥–≤–∞ –∫–ª—é—á–∞ –∑–∞ –æ–¥–Ω—É –ø–æ–∫—É–ø–∫—É.

**–ì–¥–µ**: `handlers.py`, —Ñ—É–Ω–∫—Ü–∏—è `issue_key()` –∏ –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

**–°–∏–º–ø—Ç–æ–º—ã**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ –∫–ª—é—á–∞
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –ë–î (duplicate key_email)

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ users
# ALTER TABLE users ADD COLUMN pending_payment BOOLEAN DEFAULT 0

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø–ª–∞—Ç–µ–∂–∞:
async def handle_payment(payment_id):
    user = database.get_user(user_id)
    if user.get('pending_payment'):
        logger.warning(f"User {user_id} has pending payment, ignoring")
        return
    
    database.set_pending_payment(user_id, True)
    try:
        await issue_key(user_id, ...)
    finally:
        database.set_pending_payment(user_id, False)
```

### 2. **–ü–æ—Ç–µ—Ä—è –ö–ª—é—á–µ–π –ü—Ä–∏ –û—à–∏–±–∫–µ 3x-ui**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–ª—é—á —Å–æ–∑–¥–∞–Ω –Ω–∞ –ø–∞–Ω–µ–ª–∏ 3x-ui, –Ω–æ –ø–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –ë–î –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ë–î.

**–ì–¥–µ**: `handlers.py`, —Ñ—É–Ω–∫—Ü–∏—è `issue_key()` ‚Üí `xui_api.create_or_update_key_on_host()`

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –í–µ–±—Ö—É–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–∏—à–µ–ª
2. –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –Ω–∞ 3x-ui
3. –ë–î —É–ø–∞–ª–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –∫–ª—é—á–∞ –≤ —Ç–∞–±–ª–∏—Ü—É `vpn_keys`
4. –ö–ª—é—á –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç –æ –Ω–µ–º

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ**: –¢–∞–±–ª–∏—Ü–∞ `vpn_keys_missing` –ª–æ–≥–∏—Ä—É–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã–µ –∫–ª—é—á–∏

**–£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**:
```python
# –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff
async def add_new_key_with_retry(user_id, host_name, xui_client_uuid, 
                                   key_email, expiry_timestamp_ms, max_retries=3):
    for attempt in range(max_retries):
        try:
            database.add_new_key(user_id, host_name, xui_client_uuid, 
                                key_email, expiry_timestamp_ms)
            return True
        except sqlite3.OperationalError as e:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # Exponential: 1s, 2s, 4s
                logger.warning(f"DB error, retrying in {wait_time}s: {e}")
                await asyncio.sleep(wait_time)
            else:
                logger.error(f"Failed to add key after {max_retries} attempts: {e}")
                return False
    return False
```

### 3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –í—Ä–µ–º–µ–Ω–∏ –ú–µ–∂–¥—É –°–µ—Ä–≤–µ—Ä–æ–º –∏ –ö–ª–∏–µ–Ω—Ç–æ–º**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ, —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–µ–π –±—É–¥—É—Ç –Ω–µ–≤–µ—Ä–Ω—ã–º–∏.

**–ì–¥–µ**: `scheduler.py` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π), `xui_api.py` (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π)

**–°–∏–º–ø—Ç–æ–º—ã**:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- –ö–ª—é—á–∏ –∏—Å—Ç–µ–∫–∞—é—Ç —Ä–∞–Ω—å—à–µ/–ø–æ–∑–∂–µ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `time_utils.get_msk_now()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
date

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å timezone
timedatectl

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
sudo timedatectl set-timezone Europe/Moscow
sudo timedatectl set-ntp on
```

---

## ‚öôÔ∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

### 4. **Slow Query –ø—Ä–∏ –ë–æ–ª—å—à–æ–º –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ –ö–ª—é—á–µ–π**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ 100,000+ –∫–ª—é—á–µ–π –∑–∞–ø—Ä–æ—Å—ã `SELECT * FROM vpn_keys WHERE user_id = ?` —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏.

**–ì–¥–µ**: `database.py`, —Ñ—É–Ω–∫—Ü–∏–∏ `get_user_keys()`, `get_user_paid_keys()`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
def get_user_keys(user_id):
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM vpn_keys WHERE user_id = ?', (user_id,))
        # –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ user_id!
```

**–†–µ—à–µ–Ω–∏–µ** (–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å):
```python
# –í initialize_db() –ø–æ—Å–ª–µ CREATE TABLE
cursor.execute('CREATE INDEX IF NOT EXISTS idx_vpn_keys_user_id ON vpn_keys(user_id)')
cursor.execute('CREATE INDEX IF NOT EXISTS idx_vpn_keys_expiry ON vpn_keys(expiry_date)')
cursor.execute('CREATE INDEX IF NOT EXISTS idx_transactions_user_id ON transactions(user_id)')
cursor.execute('CREATE INDEX IF NOT EXISTS idx_users_banned ON users(is_banned)')
```

### 5. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–æ–¥–ø–∏—Å–æ–∫ –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ë–æ—Ç**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç `periodic_subscription_check()` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Ö. –ü—Ä–∏ –º–∏–ª–ª–∏–æ–Ω–∞—Ö –∫–ª—é—á–µ–π —ç—Ç–æ –∑–∞–π–º–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

**–ì–¥–µ**: `scheduler.py`, —Ñ—É–Ω–∫—Ü–∏—è `periodic_subscription_check()`

**–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ –ø–æ–¥—Ä—è–¥
```python
async def periodic_subscription_check(bot_controller):
    while True:
        all_keys = database.get_all_keys()  # –ú–û–ñ–ï–¢ –ë–´–¢–¨ –û–ß–ï–ù–¨ –ú–ù–û–ì–û
        for key in all_keys:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
        await asyncio.sleep(CHECK_INTERVAL_SECONDS)
```

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**:
```python
# 1. –î–æ–±–∞–≤–∏—Ç—å batch –æ–±—Ä–∞–±–æ—Ç–∫—É
def get_keys_expiring_soon(days=2):
    # –ó–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å—Ç–µ–∫–∞—é—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ N –¥–Ω–µ–π
    cursor.execute('''
        SELECT * FROM vpn_keys 
        WHERE expiry_date BETWEEN datetime('now') AND datetime('now', '+{} days')
    '''.format(days))
    
# 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ Python
# 3. –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
```

### 6. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –ó–∞–ø—Ä–æ—Å—ã –≤ Async –ö–æ–Ω—Ç–µ–∫—Å—Ç–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í `handlers.py` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ requests –≤ async —Ñ—É–Ω–∫—Ü–∏—è—Ö.

**–ì–¥–µ**: –†–∞–±–æ—Ç–∞ —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ API (YooKassa, CryptoBot)

**–ü—Ä–æ–±–ª–µ–º–∞**: –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop!

```python
# –ü–õ–û–•–û:
async def handle_payment_yookassa(request):
    payment = Payment.find_one(payment_id)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤!
    # Event loop –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –•–û–†–û–®–û:
async def handle_payment_yookassa(request):
    payment = await asyncio.to_thread(Payment.find_one, payment_id)
    # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async –≤–µ—Ä—Å–∏—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
```

---

## üîí –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é

### 7. **SQL Injection –£—è–∑–≤–∏–º–æ—Å—Ç—å**

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ó–ê–©–ò–©–ï–ù–û** - –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–µ–∑–¥–µ

```python
# –ü–†–ê–í–ò–õ–¨–ù–û:
cursor.execute('SELECT * FROM users WHERE telegram_id = ?', (user_id,))

# –û–ü–ê–°–ù–û (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ):
cursor.execute(f'SELECT * FROM users WHERE telegram_id = {user_id}')
```

### 8. **–•—Ä–∞–Ω–µ–Ω–∏–µ –¢–æ–∫–µ–Ω–æ–≤ –≤ –û—Ç–∫—Ä—ã—Ç–æ–º –í–∏–¥–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ —Ç–æ–∫–µ–Ω—ã (Telegram Bot Token, –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `bot_settings` –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.

**–ì–¥–µ**: `database.py` —Ç–∞–±–ª–∏—Ü–∞ `bot_settings`

**–†–∏—Å–∫**: –ï—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Ç–µ—á–µ—Ç, –≤—Å–µ —Ç–æ–∫–µ–Ω—ã —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `.env` —Ñ–∞–π–ª —Å `chmod 600`

**–£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**:
```python
# –î–æ–±–∞–≤–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
from cryptography.fernet import Fernet
import os

cipher = Fernet(os.getenv("ENCRYPTION_KEY").encode())

def get_secure_setting(key):
    value = get_setting(key)
    if value and key in ['telegram_bot_token', 'yookassa_secret_key', ...]:
        try:
            return cipher.decrypt(value.encode()).decode()
        except:
            return value
    return value

def set_secure_setting(key, value):
    if key in SENSITIVE_KEYS:
        value = cipher.encrypt(value.encode()).decode()
    set_setting(key, value)
```

### 9. **CSRF –ó–∞—â–∏—Ç–∞ –≤ Flask**

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Flask session tokens

```python
# –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤—Å–µ —Ñ–æ—Ä–º—ã –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å CSRF token
# <form method="POST">
#     {{ csrf_token() }}
```

### 10. **Validation –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ë–î

**–ì–¥–µ**: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
# –û–ü–ê–°–ù–û:
amount = request.form.get('amount')  # –ú–æ–∂–µ—Ç –±—ã—Ç—å "abc" –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞
# –ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç—Å—è –≤ –ë–î –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏

# –ü–†–ê–í–ò–õ–¨–ù–û:
try:
    amount = float(request.form.get('amount'))
    if amount <= 0 or amount > 1000000:
        raise ValueError("Invalid amount")
except (ValueError, TypeError):
    flash("Invalid amount", "error")
    return redirect(...)
```

---

## üõ°Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é

### 11. **–ü—Ä–æ—Ü–µ—Å—Å –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –ú–æ–∂–µ—Ç –£–ø–∞—Å—Ç—å –ë–µ–∑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ `periodic_subscription_check()` –≤—ã–±—Ä–æ—Å–∏—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –æ–Ω –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è.

**–ì–¥–µ**: `__main__.py`, `asyncio.create_task(periodic_subscription_check(bot_controller))`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
asyncio.create_task(periodic_subscription_check(bot_controller))
# –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —É–ø–∞–¥–µ—Ç, task –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, –Ω–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
async def periodic_subscription_check_with_recovery(bot_controller):
    """Wrapper –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ"""
    while True:
        try:
            await periodic_subscription_check(bot_controller)
        except Exception as e:
            logger.error(f"periodic_subscription_check crashed: {e}", exc_info=True)
            await asyncio.sleep(60)  # –ü–æ–¥–æ–∂–¥–∞—Ç—å 1 –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
            continue

# –í __main__.py:
asyncio.create_task(periodic_subscription_check_with_recovery(bot_controller))
```

### 12. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Heartbeat –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –ë–æ—Ç–∞**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ Telegram API —É–ø–∞–¥–µ—Ç, –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ –Ω–µ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ —É–∑–Ω–∞—Ç—å —á—Ç–æ –æ–Ω "–º–µ—Ä—Ç–≤".

**–†–µ—à–µ–Ω–∏–µ**:
```python
async def bot_heartbeat_check(bot: Bot, admin_id: int):
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å Telegram"""
    while True:
        try:
            await bot.get_me()  # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ API
            logger.debug("Bot heartbeat: OK")
        except Exception as e:
            logger.error(f"Bot heartbeat failed: {e}")
            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
            try:
                await bot.send_message(admin_id, 
                    "‚ö†Ô∏è –ë–æ—Ç –ø–æ—Ç–µ—Ä—è–ª —Å–≤—è–∑—å —Å Telegram API")
            except:
                pass
        
        await asyncio.sleep(300)  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
```

### 13. **–ù–µ—Ç Timeout –Ω–∞ Webhook –ó–∞–ø—Ä–æ—Å—ã**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫ —Å –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º, —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

**–ì–¥–µ**: Flask –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤

**–†–µ—à–µ–Ω–∏–µ**:
```python
from flask import request
from functools import wraps
import signal

def timeout(seconds):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            def timeout_handler(signum, frame):
                raise TimeoutError("Webhook processing timeout")
            
            signal.signal(signal.SIGALRM, timeout_handler)
            signal.alarm(seconds)
            try:
                result = func(*args, **kwargs)
            finally:
                signal.alarm(0)
            return result
        return wrapper
    return decorator

@webhook_bp.route('/pay/yookassa', methods=['POST'])
@timeout(30)  # –ú–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
def handle_yookassa_webhook():
    # ...
```

---

## üìà –ü—Ä–æ–±–ª–µ–º—ã —Å –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é

### 14. **SQLite –ù–µ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ë–æ–ª—å—à–æ–≥–æ –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ó–∞–ø—Ä–æ—Å–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ 10,000+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SQLite –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ë–î –±—É–¥—É—Ç —á–∞—Å—Ç—ã–º–∏.

**–¢–µ–∫—É—â–µ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: SQLite –º–∞–∫—Å–∏–º—É–º ~1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–ë—É–¥—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ**: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ PostgreSQL/MySQL

```python
# –ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL:
# –í database.py –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É:
import psycopg2
from psycopg2.pool import SimpleConnectionPool

if os.getenv("DATABASE_TYPE") == "postgresql":
    pool = SimpleConnectionPool(1, 20, 
        host=os.getenv("DB_HOST"),
        database=os.getenv("DB_NAME"),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD")
    )
    def get_connection():
        return pool.getconn()
```

### 15. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:

```python
# –í handlers.py —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
yookassa_enabled = get_setting("yookassa_enabled") == "true"  # Query –∫ –ë–î!
```

**–†–µ—à–µ–Ω–∏–µ** - –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–º—è—Ç–∏ –∫—ç—à:
```python
from functools import lru_cache
import asyncio

_settings_cache = {}
_cache_expiry = 0
CACHE_DURATION = 300  # 5 –º–∏–Ω—É—Ç

async def get_setting_cached(key: str):
    global _cache_expiry, _settings_cache
    
    now = time.time()
    if now > _cache_expiry:
        _settings_cache = {}  # –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
        _cache_expiry = now + CACHE_DURATION
    
    if key not in _settings_cache:
        _settings_cache[key] = get_setting(key)  # –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    
    return _settings_cache[key]
```

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –£–ª—É—á—à–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–´–ï)

- [ ] **–î–æ–±–∞–≤–∏—Ç—å Race Condition –∑–∞—â–∏—Ç—É** –¥–ª—è –≤—ã–¥–∞—á–∏ –∫–ª—é—á–µ–π
- [ ] **–î–æ–±–∞–≤–∏—Ç—å Indices** –≤ SQLite –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] **–î–æ–±–∞–≤–∏—Ç—å Retry Logic** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –í–∞–ª–∏–¥–∞—Ü–∏—é –í—Ö–æ–¥–Ω—ã—Ö –î–∞–Ω–Ω—ã—Ö** –≤–µ–∑–¥–µ

**–í—Ä–µ–º—è**: ~ 8-16 —á–∞—Å–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–ù–´–ï)

- [ ] **–î–æ–±–∞–≤–∏—Ç—å Heartbeat Check** –¥–ª—è –±–æ—Ç–∞
- [ ] **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** (batch processing)
- [ ] **–î–æ–±–∞–≤–∏—Ç—å Timeout** –Ω–∞ –≤–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- [ ] **–£–ª—É—á—à–∏—Ç—å –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫** –≤ scheduler
- [ ] **–î–æ–±–∞–≤–∏—Ç—å –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–í—Ä–µ–º—è**: ~ 16-24 —á–∞—Å–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–õ–£–ß–®–ï–ù–ò–Ø)

- [ ] **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL** –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- [ ] **–î–æ–±–∞–≤–∏—Ç—å –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã** –≤–µ–∑–¥–µ
- [ ] **–î–æ–±–∞–≤–∏—Ç—å Unit Tests** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- [ ] **–î–æ–±–∞–≤–∏—Ç—å Prometheus –ú–µ—Ç—Ä–∏–∫–∏** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–í—Ä–µ–º—è**: ~ 40+ —á–∞—Å–æ–≤

---

## üìä –¢–∞–±–ª–∏—Ü–∞ –†–∏—Å–∫–æ–≤

| –ü—Ä–æ–±–ª–µ–º–∞ | –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ |
|---|---|---|---|---|
| Race Condition –≤ –∫–ª—é—á–∞—Ö | –ö—Ä–∏—Ç–∏—á–Ω–∞ | –°—Ä–µ–¥–Ω—è—è | –ü–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ | –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ |
| –ü–æ—Ç–µ—Ä—è –∫–ª—é—á–µ–π | –ö—Ä–∏—Ç–∏—á–Ω–∞ | –ù–∏–∑–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ | Retry –ª–æ–≥–∏–∫–∞ |
| Slow Query –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–µ | –ö—Ä–∏—Ç–∏—á–Ω–∞ | –í—ã—Å–æ–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ | –ò–Ω–¥–µ–∫—Å—ã + PostgreSQL |
| Scheduler —É–ø–∞–¥–µ—Ç | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ |
| CSRF –∞—Ç–∞–∫–∞ | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –£–∂–µ –∑–∞—â–∏—â–µ–Ω–æ |
| SQL Injection | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ | –£–∂–µ –∑–∞—â–∏—â–µ–Ω–æ |
| Slowloris –Ω–∞ webhook | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | Timeout |

---

## üöÄ –î–æ—Ä–æ–∂–Ω–∞—è –ö–∞—Ä—Ç–∞ –†–∞–∑–≤–∏—Ç–∏—è

### v2.4 (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
- –î–æ–±–∞–≤–∏—Ç—å Race Condition –∑–∞—â–∏—Ç—É
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î –∑–∞–ø—Ä–æ—Å—ã
- –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ scheduler

### v2.5 (–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å)
- –î–æ–±–∞–≤–∏—Ç—å Heartbeat check
- –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### v2.6 (–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏ (Celery/RQ)
- Horizontal scaling support

### v3.0 (Enterprise)
- Multi-domain –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –ë–µ–ª–∞—è –º–µ—Ç–∫–∞ (white-label) –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
- API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤

---

## üìû –ü—Ä–æ—Ü–µ—Å—Å –û—Ç–ª–∞–¥–∫–∏

1. **–í–∫–ª—é—á–∏—Ç—å DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   ```python
   logger.setLevel(logging.DEBUG)
   ```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker logs –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**:
   ```bash
   docker logs -f --tail 100 <container> | grep -i "debug\|error"
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –Ω–∞–ø—Ä—è–º—É—é**:
   ```bash
   sqlite3 users.db "SELECT * FROM transactions ORDER BY transaction_id DESC LIMIT 5;"
   ```

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º**:
   ```bash
   python -m pytest tests/ -v
   ```

5. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
   ```bash
   curl -X POST http://localhost:1488/pay/yookassa -d '{"payment_id": "test"}'
   ```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 5 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0  
**–°—Ç–∞—Ç—É—Å**: –ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è v2.3.7
