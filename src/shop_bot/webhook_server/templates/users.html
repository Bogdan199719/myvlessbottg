{% extends "base.html" %} {% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock
%} {% block content %}

<h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>

<section class="settings-section">
	<h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>

	<div class="table-toolbar">
		<div class="table-tools">
			<input id="usersSearch" class="search-input" type="text" placeholder="Search by ID or username" />
			<div class="filter-group">
				<button type="button" class="filter-chip is-active" data-user-filter="all">All</button>
				<button type="button" class="filter-chip" data-user-filter="active">Active</button>
				<button type="button" class="filter-chip" data-user-filter="banned">Banned</button>
			</div>
		</div>
		<div class="count-pill">Shown: <span id="usersCount"></span></div>
	</div>

	<div style="overflow-x: auto">
		<table class="users-table">
			<thead>
				<tr>
					<th>Telegram ID</th>
					<th>Username</th>
					<th>–°—Ç–∞—Ç—É—Å</th>
					<th>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏</th>
					<th class="actions-cell">–î–µ–π—Å—Ç–≤–∏—è</th>
				</tr>
			</thead>
			<tbody>
				{% for user in users %}
				<tr data-status="{{ 'banned' if user.is_banned else 'active' }}" data-search="{{ user.telegram_id }} {{ user.username or '' }}">
					<td>{{ user.telegram_id }}</td>
					<td>@{{ user.username or 'N/A' }}</td>
					<td>
						{% if user.is_banned %}
						<span class="status-badge status-banned">–ó–∞–±–∞–Ω–µ–Ω</span>
						{% else %}
						<span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>
						{% endif %}
					</td>
					<td>
						{% if user.user_keys %} {{ user.user_keys | length }} —à—Ç. {% else %}
						0 {% endif %}
					</td>
					<td class="actions-cell">
						<div class="actions-wrapper">
							<button type="button" class="button button-success button-small"
								onclick="openIssueModal('{{ user.telegram_id }}', '{{ user.username }}')">
								–í—ã–¥–∞—Ç—å
							</button>

							{% if user.is_banned %}
							<form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post"
								style="display:inline;">
								<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
								<button type="submit" class="button button-start button-small">
									–†–∞–∑–±–∞–Ω
								</button>
							</form>
							{% else %}
							<form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post"
								data-confirm="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –û–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º."
								style="display:inline;">
								<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
								<button type="submit" class="button button-warning button-small">
									–ë–∞–Ω
								</button>
							</form>
							{% endif %}
							<form action="{{ url_for('delete_user_route', user_id=user.telegram_id) }}" method="post"
								data-confirm="–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è –æ–ø–ª–∞—Ç—ã/–∏—Å—Ç–æ—Ä–∏—é) –∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
								style="display:inline;">
								<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
								<button type="submit" class="button button-danger button-small">
									–£–¥–∞–ª–∏—Ç—å
								</button>
							</form>
							{% if user.user_keys %}
							<form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post"
								data-confirm="–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–æ–≤. –í—ã —É–≤–µ—Ä–µ–Ω—ã?"
								style="display:inline;">
								<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
								<button type="submit" class="button button-danger button-small">
									–û—Ç–æ–∑–≤–∞—Ç—å
								</button>
							</form>
							{% endif %}
						</div>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</section>

<!-- Issue Key Modal -->
<div id="issueKeyModal" class="modal">
	<div class="modal-content">
		<span class="close" onclick="closeIssueModal()">&times;</span>
		<h2>–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h2>
		<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="modalUsername"></span> (ID: <span id="modalUserIdDisplay"></span>)</p>

		<form id="issueKeyForm" method="post" action="">
			<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

			<div class="form-group">
				<label for="planSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ:</label>
				<select name="plan_id" id="planSelect" required class="form-control">
					<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ --</option>

					{% if issuance_data.global_plans %}
					<optgroup label="üåç –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã)">
						{% for plan in issuance_data.global_plans %}
						<option value="{{ plan.plan_id }}">
							{{ plan.plan_name }} ({{ plan.months }} –º–µ—Å.) - {{ plan.price }}‚ÇΩ
						</option>
						{% endfor %}
					</optgroup>
					{% endif %}

					{% for host_name, plans in issuance_data.host_plans.items() %}
					<optgroup label="{{ host_name }}">
						{% for plan in plans %}
						<option value="{{ plan.plan_id }}">
							{{ plan.plan_name }} ({{ plan.months }} –º–µ—Å.) - {{ plan.price }}‚ÇΩ
						</option>
						{% endfor %}
					</optgroup>
					{% endfor %}
				</select>
			</div>

			<div class="form-actions">
				<button type="submit" class="button button-success">–í—ã–¥–∞—Ç—å</button>
				<button type="button" class="button button-secondary" onclick="closeIssueModal()">–û—Ç–º–µ–Ω–∞</button>
			</div>
		</form>
	</div>
</div>

<script>
	function openIssueModal(userId, username) {
		var modal = document.getElementById("issueKeyModal");
		var form = document.getElementById("issueKeyForm");

		document.getElementById("modalUsername").textContent = username ? "@" + username : "–ë–µ–∑ —é–∑–µ—Ä–Ω–µ–π–º–∞";
		document.getElementById("modalUserIdDisplay").textContent = userId;

		// Set form action dynamically
		form.action = "/users/issue-key/" + userId;

		modal.style.display = "block";
	}

	function closeIssueModal() {
		var modal = document.getElementById("issueKeyModal");
		modal.style.display = "none";
	}

	// Close modal if clicked outside
	window.onclick = function (event) {
		var modal = document.getElementById("issueKeyModal");
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}
</script>



{% endblock %}