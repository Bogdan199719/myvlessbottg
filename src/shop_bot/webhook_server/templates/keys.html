{% extends "base.html" %} {% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏{% endblock %} {% block
content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏</h1>
    <div style="display: flex; gap: 10px;">
        <form action="{{ url_for('fix_client_parameters') }}" method="POST"
            onsubmit="return confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏—Å–ø—Ä–∞–≤–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã flow –∏ encryption –¥–ª—è –í–°–ï–• –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–∞–Ω–µ–ª—è—Ö XUI. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="button button-warning">üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</button>
        </form>
    </div>
</div>

<section class="keys-section">
    <div style="overflow-x: auto">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <!-- User column removed, using group header -->
                    <th>–•–æ—Å—Ç</th>
                    <th>Email</th>
                    <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                    <th>–°—Ç–∞—Ç—É—Å (–¥–Ω–µ–π)</th>
                    <th style="text-align: right">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in grouped_users %}
                <tr style="background-color: #3b4250; border-bottom: 2px solid var(--border-color);">
                    <td colspan="6" style="padding: 10px 15px;">
                        <strong style="font-size: 1.1em; color: var(--primary-color);">
                            <a href="{{ url_for('users_page') }}#user-{{ user.user_id }}"
                                style="text-decoration: none; color: inherit;">
                                {{ user.username }}
                            </a>
                        </strong>
                        <small style="color: #adb5bd; margin-left: 10px;">ID: {{ user.user_id }}</small>
                    </td>
                </tr>
                {% for key in user.user_keys %}
                <tr style="background-color: #2d3238;">
                    <td>{{ key.key_id }}</td>
                    <td>{{ key.host_name }}</td>
                    <td>
                        <small>{{ key.key_email }}</small>
                    </td>
                    <td>
                        {% if key.expiry_date %}
                        {{ key.expiry_date.split('T')[0] }}
                        {% else %}
                        ‚àû
                        {% endif %}
                    </td>
                    <td>
                        {% if key.days_left is defined %}
                        {% if key.days_left < 0 %} <span class="status-badge status-banned">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
                            {% elif key.days_left < 3 %} <span class="status-badge status-warning">{{ key.days_left }}
                                –¥–Ω.</span>
                                {% else %}
                                <span class="status-badge status-active">{{ key.days_left }} –¥–Ω.</span>
                                {% endif %}
                                {% endif %}
                    </td>
                    <td class="actions-cell">
                        <form action="{{ url_for('adjust_key_duration', key_id=key.key_id) }}" method="POST"
                            class="form-inline"
                            onsubmit="var d = parseInt(this.days.value) || 0; var h = parseInt(this.hours.value) || 0; if(d === 0 && h === 0) { alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∏–ª–∏ —á–∞—Å–æ–≤'); return false; } var txt = (d >= 0 && h >= 0) ? '–ø—Ä–æ–¥–ª–∏—Ç—å' : '—É–º–µ–Ω—å—à–∏—Ç—å —Å—Ä–æ–∫'; return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ' + txt + ' –∫–ª—é—á #{{ key.key_id }}?');"
                            style="display: flex; gap: 5px; justify-content: flex-end; align-items: center;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span style="font-size: 0.7em; color: #adb5bd;">–î–Ω–µ–π</span>
                                    <input type="number" name="days" value="0" min="-365" max="365"
                                        style="width: 50px; padding: 2px; text-align: center;"
                                        oninput="checkChanges(this.form)" />
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span style="font-size: 0.7em; color: #adb5bd;">–ß–∞—Å–æ–≤</span>
                                    <input type="number" name="hours" value="0" min="-23" max="23"
                                        style="width: 50px; padding: 2px; text-align: center;"
                                        oninput="checkChanges(this.form)" />
                                </div>
                                <button type="submit" class="button button-small button-success"
                                    style="display: none; margin-left: 5px;" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                                    OK
                                </button>
                            </div>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    function checkChanges(form) {
        const days = parseInt(form.days.value) || 0;
        const hours = parseInt(form.hours.value) || 0;
        const btn = form.querySelector('button[type="submit"]');

        if (days !== 0 || hours !== 0) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    }
</script>


{% endblock %}