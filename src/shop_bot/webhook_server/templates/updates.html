{% extends 'base.html' %}

{% block title %}–û–±–Ω–æ–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<section class="content-header">
    <h1><i class="fas fa-sync-alt"></i> –¶–µ–Ω—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–µ–π –±–æ—Ç–∞</p>
</section>

<div class="card">
    <div class="card-body update-container">
        <div class="current-version">
            <h3>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è</h3>
            <span class="badge badge-primary">{{ current_version }}</span>
        </div>

        <div class="update-actions">
            <button id="checkUpdatesBtn" class="button button-primary">
                <i class="fas fa-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            </button>
        </div>

        <div id="updateStatusArea" class="update-status hidden">
            <!-- Dynamic Content -->
        </div>
        
        <div id="updateLog" class="terminal-log hidden">
            <!-- Logs -->
        </div>
    </div>
</div>

<script>
document.getElementById('checkUpdatesBtn').addEventListener('click', async () => {
    const btn = document.getElementById('checkUpdatesBtn');
    const statusArea = document.getElementById('updateStatusArea');
    const logArea = document.getElementById('updateLog');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    statusArea.classList.add('hidden');
    
    try {
        const response = await fetch("{{ url_for('check_updates_route') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        const json = await response.json();
        
        statusArea.classList.remove('hidden');
        
        if (json.status === 'success') {
            const data = json.data;
            if (data.update_available) {
                statusArea.innerHTML = `
                    <div class="alert alert-info">
                        <h4>üî• –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${data.latest_version}</h4>
                        <p>${data.release_notes || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞.'}</p>
                        <button id="performUpdateBtn" class="button button-success">
                            <i class="fas fa-cloud-download-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                        </button>
                    </div>
                `;
                
                document.getElementById('performUpdateBtn').addEventListener('click', performUpdate);
            } else {
                statusArea.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> –£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è.
                    </div>
                `;
            }
        } else {
            statusArea.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${json.message}</div>`;
        }
    } catch (e) {
        statusArea.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞';
    }
});

async function performUpdate() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞.')) return;
    
    const statusArea = document.getElementById('updateStatusArea');
    statusArea.innerHTML = '<div class="alert alert-warning"><i class="fas fa-cog fa-spin"></i> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è.</div>';
    
    try {
        const response = await fetch("{{ url_for('perform_update_route') }}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        });
        const json = await response.json();
        
        if (json.status === 'success') {
            statusArea.innerHTML = '<div class="alert alert-success">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>';
            setTimeout(() => window.location.reload(), 10000);
        } else {
            statusArea.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${json.message}</div>`;
        }
    } catch (e) {
         statusArea.innerHTML = '<div class="alert alert-warning">–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä —É–∂–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.</div>';
    }
}
</script>

<style>
    .update-container {
        text-align: center;
        padding: 40px;
    }
    .current-version h3 { margin-bottom: 10px; }
    .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; }
    .badge-primary { background: #007bff; color: white; }
    .update-actions { margin: 30px 0; }
    .hidden { display: none; }
    .alert { padding: 15px; border-radius: 5px; margin-top: 20px; text-align: left; }
    .alert-info { background: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; }
    .alert-success { background: #e8f5e9; color: #1b5e20; border: 1px solid #a5d6a7; }
    .alert-danger { background: #ffebee; color: #b71c1c; border: 1px solid #ef9a9a; }
    .alert-warning { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
    .terminal-log { background: #1e1e1e; color: #00e676; font-family: monospace; padding: 15px; text-align: left; margin-top: 20px; border-radius: 5px; }
</style>
{% endblock %}
